<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Monday, March 28, 2022, 1:55 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "Debuff_Prompt" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Debuff_Prompt"
   author="Gaballon"
   id="138dca5ec1e3dd1e9a387910"
   language="Lua"
   purpose="Display important debuff information after the Aardwolf prompt."
   save_state="y"
   date_written="2022-03-28 13:54:09"
   requires="5.07"
   version="1.0"
   >
</plugin>

<aliases>

<alias
   script="dpr_command"
   match="^dpr( disable| enable| reset)$"
   regexp="y"
   enabled="y"
   sequence="100"
   ignore_case="y"
></alias>

</aliases>

<triggers>

<trigger
   name="prompt"
   group="dpr"
   enabled="y"
   keep_evaluating="y"
   match="^\&lt; (.*?) \&gt;$"
   omit_from_output="y"
   regexp="y"
   send_to="14"
   sequence="100"
>
  <send>
    --Note("Prompt trigger activated.")
	--TSRtable = TriggerStyleRuns
	format_prompt(TriggerStyleRuns)
  </send>
</trigger>

<trigger
   name="prompt2"
   group="dpr"
   enabled="y"
   keep_evaluating="y"
   match="^\&lt; (.*?) \&gt;\*\[NOEXP\]\*"
   omit_from_output="y"
   regexp="y"
   send_to="14"
   sequence="100"
>
  <send>
    --Note("Prompt2 trigger activated.")
	--TSRtable = TriggerStyleRuns
	format_prompt(TriggerStyleRuns)
  </send>
</trigger>
 
<trigger
     name="debuff_off"
	 group="dpr"
     enabled="y"
     match="^\{affoff\}(?<spell>[0-9]{1,3})"
     regexp="y"
     omit_from_output="y"
     sequence="100"
     script="debuff_off"
>
</trigger>

<trigger
     name="debuff_on"
	 group="dpr"
     enabled="y"
     match="^\{affon\}(?<spell>[0-9]{1,3}),(?<time>[0-9]{1,5})"
     regexp="y"
     omit_from_output="y"
     sequence="100"
     script="debuff_on"
>
</trigger>

</triggers>

<script>
<![CDATA[

dofile (GetInfo(60) .. "aardwolf_colors.lua")
require "tprint"

function dpr_command(aliasname, aliasline, wildcards)
	print("dpr_command called with variables:\n name: " .. aliasname .. "\n line: " .. aliasline .. "\n wildcard1: " .. wildcards[1])
	if wildcards[1] == " disable" then
		print("Disabling Debuff_Prompt.")
		EnableTriggerGroup("dpr", false)
	elseif wildcards[1] == " enable" then
		print("Enabling Debuff_Prompt.")
		EnableTriggerGroup("dpr", true)
	elseif wildcards[1] == " reset" then
		print("Resetting Debuff_Prompt variables.")
		init()
	else
		print("Command not recognized.")
	end
end

function format_prompt(style_table)
	output = stylesToANSI(style_table)
	--print(output)
	for w in string.gmatch(output, "%d+") do
		--print(w, string.len(w))
		if string.len(w) > 4 then
			formatted_w = string.sub(w, 1, string.len(w) - 3) .. "," .. string.sub(w, -3)
			output = string.gsub(output, w, formatted_w)
		elseif string.len(w) == 4 then
			formatted_w = string.sub(w, 1, 1) .. "," .. string.sub(w, 2)
			output = string.gsub(output, w, formatted_w)
		else
		end
	end
	--print(output)
	append_debuffs(output)	
end

function append_debuffs(formatted_output)
	for key, value in pairs(debuffs) do
		if value["aff"] == true then 
			formatted_output = formatted_output .. value["app"]
		end
	end
	AnsiNote(formatted_output)
end

function debuff_off(name, line, wilds)
	local spell = tonumber(wilds.spell)
	for key, value in pairs(debuffs) do
		if spell == tonumber(key) then
			value["aff"] = false
			--print("Set", value["name"], "to false.")
			break
		end
	end
end

function debuff_on(name, line, wilds)
	local spell = tonumber(wilds.spell)
	for key, value in pairs(debuffs) do
		if spell == tonumber(key) then
			value["aff"] = true
			--print("Set", value["name"], "to true.")
			break
		end
	end
end

function init()
	EnableTriggerGroup("dpr", true)
	debuffs = {
		[29] = {
			["name"] = "curse",
			["aff"] = false,
			["app"] = ColoursToANSI(" @M(C)@w")
			},
		[65] = {
			["name"] = "disease",
			["aff"] = false,
			["app"] = ColoursToANSI(" @y(D)@w")
			},
		[288] = {
			["name"] = "green",
			["aff"] = false,
			["app"] = ColoursToANSI(" @G(G)@w")
			},
		[66] = {
			["name"] = "poison",
			["aff"] = false,
			["app"] = ColoursToANSI(" @g(P)@w")
			},
		[145] = {
			["name"] = "rainbow",
			["aff"] = false,
			["app"] = ColoursToANSI(" @R(R)@w")
			},
		[81] = {
			["name"] = "weaken",
			["aff"] = false,
			["app"] = ColoursToANSI(" @c(Wk)@w")
			},
		[237] = {
			["name"] = "web",
			["aff"] = false,
			["app"] = ColoursToANSI(" @Y(Wb)@w")
			}
		}
end

function OnPluginInstall()
	OnPluginEnable()
end

function OnPluginEnable()
	print("Debuff_Prompt plugin enabled.")
	init()
end

function OnPluginSaveState()

end

function OnPluginDisable()

end

function OnPluginClose()
	OnPluginDisable()
end

]]>
</script>

</muclient>
